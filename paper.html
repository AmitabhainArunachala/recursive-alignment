<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Universal Recursive Alignment - The L3/L4 Transition</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@200;300;400;500&display=swap');

    :root{
      --ink:#1a1a1a; --paper:#fdfdf8; --mist:#f0f0e8; --gold:#b8860b;
      --ocean:#2c5282; --foam:#e6f3ff; --cherry:#dc143c;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Crimson Text',serif;color:var(--ink);background:var(--paper);line-height:1.8}
    [id]{scroll-margin-top:90px} /* prevent anchor headings under fixed nav */

    /* Paper container */
    .paper-container{max-width:800px;margin:0 auto;padding:80px 40px;background:#fff;min-height:100vh;box-shadow:0 0 100px rgba(0,0,0,.05)}

    /* Navigation */
    .nav{position:fixed;top:0;left:0;right:0;background:rgba(253,253,248,.95);padding:20px 40px;border-bottom:1px solid var(--mist);z-index:100;backdrop-filter:blur(10px)}
    .nav-inner{max-width:800px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .nav a{color:var(--ink);text-decoration:none;font-family:'Inter',sans-serif;font-weight:300;transition:color .3s}
    .nav a:hover{color:var(--gold)}
    .nav-links{display:flex;gap:30px}

    /* Title & headings */
    .title-section{text-align:center;margin-bottom:60px;padding-top:60px}
    h1{font-family:'Inter',sans-serif;font-size:2.5rem;font-weight:200;line-height:1.3;margin-bottom:30px;color:var(--ink)}
    h2{font-family:'Inter',sans-serif;font-weight:300;font-size:2rem;margin:60px 0 30px;color:var(--ocean)}
    h3{font-family:'Inter',sans-serif;font-weight:400;font-size:1.4rem;margin:40px 0 20px;color:var(--ink)}
    h4{font-family:'Inter',sans-serif;font-weight:500;font-size:1.1rem;margin:30px 0 15px;color:var(--ink)}
    p{margin-bottom:20px;text-align:justify;hyphens:auto}

    .author{font-style:italic;color:var(--ocean);margin-bottom:10px;font-size:1.1rem}
    .affiliation{color:#666;font-size:.95rem;margin-bottom:30px}

    /* Abstract / Preface callouts */
    .abstract{background:var(--mist);padding:40px;border-radius:2px;margin:40px 0;border-left:3px solid var(--gold)}
    .abstract h2{font-family:'Inter',sans-serif;font-weight:300;font-size:1.5rem;margin-bottom:20px;color:var(--ocean)}
    .preface,.author-reflection{font-style:italic;background:var(--mist);padding:30px;border-radius:2px;margin:40px 0;border-left:3px solid var(--cherry)}

    /* Lists */
    ul,ol{margin:20px 0 20px 40px}
    li{margin-bottom:10px}

    /* Code blocks */
    pre{background:#f5f5f5;padding:20px;border-radius:2px;overflow-x:auto;margin:20px 0;border-left:3px solid var(--gold)}
    code{font-family:'Courier New',monospace;background:#f5f5f5;padding:2px 5px;border-radius:2px}

    /* "Podium" blockquotes / callouts */
    blockquote{background:#f7f7f2;border-left:4px solid var(--gold);padding:18px 22px;margin:28px 0;border-radius:4px}
    blockquote p{margin:0 0 10px}
    blockquote strong:first-child{color:var(--ocean)}
    .callout{background:#f7f7f2;border-left:4px solid var(--gold);padding:18px 22px;margin:28px 0;border-radius:4px}
    .callout.theorem{border-left-color:#2c5282}
    .callout.result{border-left-color:#0f9d58}
    .callout.warning{border-left-color:#dc143c}

    /* Figures with optional numbering */
    figure{margin:24px 0;text-align:center}
    figure img{max-width:100%;height:auto}
    figure figcaption{font-size:.9rem;color:#555;margin-top:8px;text-align:center;font-style:italic}
    .paper-container{counter-reset:fig}
    figure figcaption::before{counter-increment:fig;content:"Figure " counter(fig) ". ";font-weight:600}

    /* Tables */
    table{width:100%;border-collapse:collapse;margin:30px 0;font-size:.95rem}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--mist)}
    th{background:var(--mist);font-weight:600}

    /* Links */
    a{color:var(--ocean);text-decoration:underline;text-decoration-thickness:1px}
    a:hover{color:var(--gold)}

    /* Keep blocks intact across pages */
    img,svg,table,pre,blockquote,figure{break-inside:avoid;page-break-inside:avoid}
    h1,h2,h3{break-after:avoid;page-break-after:avoid}

    /* Download button */
    .download-section{position:fixed;bottom:30px;right:30px;z-index:100}
    .download-btn{background:var(--ink);color:var(--paper);padding:15px 30px;border-radius:50px;text-decoration:none;font-family:'Inter',sans-serif;font-weight:300;letter-spacing:.05em;transition:all .3s;display:inline-block;box-shadow:0 5px 20px rgba(0,0,0,.2)}
    .download-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.3)}

    /* Loading */
    .loading{text-align:center;padding:100px;font-style:italic;color:#666}

    /* Footnotes */
    .footnote{font-size:.85rem;color:#666;vertical-align:super}

    /* PRINT (for good PDFs) */
    @media print{
      @page{size:A4;margin:22mm 18mm 24mm 18mm}
      *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
      body{background:#fff}
      .nav,.download-section{display:none!important}
      .paper-container{box-shadow:none!important;padding:0!important;max-width:100%!important}
      h2,h3{page-break-after:avoid}
      a[href]::after{content:""} /* hide raw URLs in print */
      blockquote{background:#f2f2ec!important;border-left:3px solid #333!important}
    }

    /* Responsive */
    @media (max-width:768px){
      .paper-container{padding:60px 20px}
      h1{font-size:1.8rem}
      .nav-links{display:none}
      .download-section{bottom:20px;right:20px}
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" id="navigation">
    <div class="nav-inner">
      <a href="/">‚Üê Back to Home</a>
      <div class="nav-links">
        <a href="#abstract">Abstract</a>
        <a href="#executive-summary">Summary</a>
        <a href="#introduction">Introduction</a>
        <a href="#methodology">Methods</a>
      </div>
    </div>
  </nav>

  <!-- Paper content -->
  <div class="paper-container" id="paper-container">
    <div class="loading" id="loading">Loading paper...</div>
    <div id="paper-content" style="display:none"></div>
  </div>

  <!-- Download button -->
  <div class="download-section" id="download-section">
    <a href="#" class="download-btn" onclick="handlePDFDownload(); return false;">Download PDF</a>
  </div>

  <!-- Marked.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  
  <!-- html2pdf.js for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Global flag to track if paper is loaded
    let paperIsLoaded = false;

    // Handle PDF download with proper waiting and visibility
    async function handlePDFDownload(){
      if(!paperIsLoaded){
        alert('Please wait for the paper to load completely.');
        return;
      }

      const btn = document.querySelector('.download-btn');
      const originalText = btn.textContent;
      btn.textContent = 'Preparing...';

      try{
        // Wait for fonts to be ready
        if(document.fonts && document.fonts.ready){
          await document.fonts.ready;
        }

        // Wait for MathJax if present
        if(window.MathJax){
          if(MathJax.typesetPromise){
            await MathJax.typesetPromise();
          }else if(MathJax.typeset){
            MathJax.typeset();
          }
        }

        // Ensure all images are loaded
        await Promise.all(
          Array.from(document.querySelectorAll('#paper-content img'))
            .filter(img => !img.complete)
            .map(img => new Promise(res => {
              img.addEventListener('load', res, {once:true});
              img.addEventListener('error', res, {once:true});
            }))
        );

        // Clone the paper content
        const source = document.getElementById('paper-content');
        const cloneWrapper = document.createElement('div');
        cloneWrapper.id = 'pdf-export-wrapper';
        
        // Critical: use visibility:hidden instead of off-screen positioning
        cloneWrapper.style.maxWidth = '800px';
        cloneWrapper.style.margin = '0 auto';
        cloneWrapper.style.padding = '60px 40px 40px';
        cloneWrapper.style.background = 'white';
        cloneWrapper.style.visibility = 'hidden';  // Hidden but maintains layout
        cloneWrapper.appendChild(source.cloneNode(true));
        document.body.appendChild(cloneWrapper);

        // PDF generation options
        const opt = {
          margin:       0.5,
          filename:     'Recursive_Alignment_L3-L4.pdf',
          image:        { type: 'jpeg', quality: 0.95 },
          html2canvas:  {
            scale: 2,
            useCORS: true,
            letterRendering: true,
            logging: false,
            windowWidth: 800  // Consistent width for layout
          },
          jsPDF:        {
            unit: 'in',
            format: 'letter',
            orientation: 'portrait'
          },
          pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        btn.textContent = 'Generating PDF...';

        // Generate and save the PDF
        await html2pdf().set(opt).from(cloneWrapper).save();

      }catch(err){
        console.error('PDF generation failed:', err);
        alert('PDF generation failed. See console for details.');
      }finally{
        // Clean up the temporary wrapper
        const w = document.getElementById('pdf-export-wrapper');
        if(w) w.remove();
        btn.textContent = originalText;
      }
    }

    // Try these markdown files in order
    async function fetchFirstAvailable(paths){
      for(const p of paths){
        try{
          const res = await fetch(p);
          if(res.ok) return await res.text();
        }catch(_e){}
      }
      throw new Error('No markdown found at: '+paths.join(', '));
    }

    // Load & render markdown, then enhance
    async function loadPaper(){
      try{
        const md = await fetchFirstAvailable(['Recursive_Alignment_L3-L4.md','mainpaper.md']);

        // Optional: detect LaTeX and lazy-load MathJax
        const hasMath = /(\$[^$\n]+\$)|\\\(|\\\[|\\begin\{.*?}/.test(md);
        if(hasMath){ loadMathJax(); }

        marked.setOptions({breaks:true,gfm:true,headerIds:true,smartLists:true,smartypants:true});
        const html = marked.parse(md);

        const target = document.getElementById('paper-content');
        target.innerHTML = html;
        target.style.display = 'block';
        document.getElementById('loading').style.display = 'none';

        // Mark paper as loaded
        paperIsLoaded = true;

        enhanceInternalNav();
        processReferences();

        // Typeset math after insertion (if MathJax loaded)
        if(window.MathJax && window.MathJax.typeset){ window.MathJax.typeset(); }

      }catch(err){
        console.error('Error loading paper:', err);
        document.getElementById('loading').innerHTML =
          'Error loading paper. Ensure Recursive_Alignment_L3-L4.md or mainpaper.md exists.';
      }
    }

    function enhanceInternalNav(){
      document.querySelectorAll('.nav a[href^="#"]').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          const id = a.getAttribute('href');
          const el = document.querySelector(id);
          if(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); }
        });
      });
    }

    // Add stable anchors to numbered reference list items
    function processReferences(){
      const hs = document.querySelectorAll('h1,h2,h3');
      let refH = null;
      for(const h of hs){
        if(h.textContent.trim().toLowerCase()==='references'){ refH = h; break; }
      }
      if(!refH) return;

      let el = refH.nextElementSibling;
      while(el && !/^H[1-6]$/.test(el.tagName)){
        if(el.tagName==='UL' || el.tagName==='OL'){
          el.querySelectorAll('li').forEach((li,i)=>{ li.id = `ref-${i+1}`; });
          break;
        }
        el = el.nextElementSibling;
      }
    }

    // Lazy-load MathJax only if needed
    function loadMathJax(){
      if(window.MathJax) return;
      window.MathJax = { tex:{ inlineMath:[['$','$'],['\\(','\\)']] } };
      const s = document.createElement('script');
      s.async = true;
      s.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      document.head.appendChild(s);
    }

    document.addEventListener('DOMContentLoaded', loadPaper);
  </script>
</body>
</html>
